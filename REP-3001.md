```
REP: 3001
Title: Glyph Protocol v2 (Core)
Author: C. Donnachie
Status: Draft
Type: Standard
Created: 2026-01-24
Requires: None
License: MIT
Original: RIP-GLYPH-0002
```

## Abstract

This proposal defines **Glyph Protocol v2**, extending the existing Glyph commit/reveal mechanism to support
**structured smart assets**: typed files, multi-file bundles, previews, safety flags, relationships, and optional
authorized mutable state.

## Motivation

Glyph v1 enables data inscription but lacks standard semantics for:

- file typing and safe previews
- multi-file assets (books/games/mods)
- deterministic indexing across implementations
- optional mutable "state" for game items and evolving metadata

## Specification

### Design Goals

- UTXO-native, deterministic, indexer-friendly
- canonical serialization → stable commit hash
- immutable content hashes; optional constrained mutable fields
- safe-by-default rendering behavior in wallets/explorers
- extensible via application profiles (`app.namespace`, `app.schema`)

## Backwards Compatibility

Glyph v2 **does not change the magic bytes** used by v1:

- Magic ASCII: `gly`
- Magic hex: `676c79`

v2 introduces a **version byte** after the magic:

- v1: `gly || <v1 payload>`
- v2: `gly || 0x02 || <v2 payload>`

Indexers MUST inspect the first byte after magic to determine the version.

### Terminology

- **Commit**: Anchors a hash of canonical metadata bytes.
- **Reveal**: Publishes canonical metadata bytes and payloads/refs.
- **Update**: Optional mutation of whitelisted fields with controller authorization.
- **Controller**: pubkey or script-hash authorized to produce updates.
- **GlyphID**: canonical identifier of a glyph (indexer policy; RECOMMENDED: reveal outpoint `txid:vout`).

---

### Canonical Metadata Bytes

### 6.1 Encoding

Metadata MUST be serialized to canonical bytes before hashing:

- **CBOR (canonical)** — RECOMMENDED
- **Canonical JSON** — OPTIONAL, using RFC 8785 (JCS)

Indexers MUST treat the commit hash as the hash of canonical bytes, not of a pretty-printed string.

### 6.2 Hash function

`commit_hash = SHA256(canonical_metadata_bytes)` (32 bytes)

(Alternative hash algorithms MAY be introduced by a future REP; v2 fixes SHA256.)

---

### Metadata Schema (Normative)

### 7.1 Field length limits (normative)

| Field          | Max Length             |
| -------------- | ---------------------- |
| `name`         | 256 UTF-8 bytes        |
| `desc`         | 4,096 UTF-8 bytes      |
| `path` (any)   | 512 UTF-8 bytes        |
| `mime`         | 128 UTF-8 bytes        |
| Total metadata | 256 KB canonical bytes |

Implementations MUST reject metadata exceeding these limits.

### 7.2 Top-level keys

- `v` (uint): MUST be `2`
- `type` (text): one of  
  `bundle | image | audio | video | text | book | model | game_item | script | other`  
  Namespaced types MAY be used for application profiles (e.g., `rxd.game/item`)
- `name` (text): human-friendly name (≤256 bytes)
- `desc` (text): description (optional, ≤4KB)
- `created` (uint64): unix epoch seconds (optional but recommended)
- `creator` (map): creator identity and signature (optional, see §7.3)
- `content` (map): declared files/refs and primary entry
- `preview` (map): thumbnail + UX hints (optional, see §9)
- `policy` (map): safety flags (required)
- `rights` (map): licensing and royalty hints (non-consensus, see §7.4)
- `rels` (array): relationship edges to other glyphs (non-consensus)
- `mutable` (map): mutable policy + controller (optional)
- `app` (map): application namespace + profile schema + app data (optional)
- `commit_outpoint` (text): explicit reference to commit transaction (RECOMMENDED, format: `txid:vout`)

Unknown keys MUST be ignored unless the indexer recognizes the namespace/profile.

### 7.3 Creator signature (normative)

If `creator` is present, it MUST include:

- `pubkey` (text): 33-byte compressed public key, hex-encoded
- `sig` (text): signature, hex-encoded
- `algo` (text): signature algorithm, one of `ecdsa-secp256k1 | schnorr-secp256k1`

The signed message MUST be:

```
SHA256("glyph-v2-creator:" || commit_hash)
```

Where `commit_hash` is the SHA256 of the canonical metadata bytes **with the `creator.sig` field set to empty string** during signing.

Verification:

1. Set `creator.sig = ""`
2. Compute `temp_hash = SHA256(canonical_bytes)`
3. Compute `message = SHA256("glyph-v2-creator:" || temp_hash)`
4. Verify `sig` against `message` using `pubkey` and `algo`

### 7.4 Rights model (non-consensus)

If `rights` is present, it MAY include:

- `license` (text): SPDX identifier or URL (e.g., `"CC-BY-4.0"`, `"https://example.com/license"`)
- `royalty_bps` (uint): royalty in basis points (e.g., 250 = 2.5%)
- `royalty_address` (text): Radiant address for royalty payments
- `attribution` (text): required attribution text

These fields are advisory only; enforcement is application-specific.

---

### Content Model (Normative)

`content.mode`:

- `inline`: payload bytes are carried in the reveal envelope
- `refs`: payload bytes are external, but MUST be integrity-protected by hashes

`content.primary` MUST include:

- `path` (text)
- `mime` (text)
- `size` (uint)
- `hash` (map): `{ algo, hex }` — `algo` MUST be `"sha256"` in v2
- `encoding` (text): `raw | base64`
- `compression` (text): `none | gzip | zstd`

`content.files` is an array of additional files with the same required fields.

`content.refs` is an array of external references. Each ref MUST include:

- `path` (text)
- `uri` (text)
- `size` (uint)
- `hash` (map): `{ algo, hex }`

---

### Preview Model (Normative)

### 9.1 Preview schema

If present, `preview` MUST include:

- `thumb` (map): thumbnail reference with the following fields:
  - `path` (text): path to thumbnail in `content.files` or `content.refs`
  - `mime` (text): MIME type (SHOULD be `image/png`, `image/jpeg`, or `image/webp`)
  - `width` (uint): width in pixels (RECOMMENDED: ≤512)
  - `height` (uint): height in pixels (RECOMMENDED: ≤512)

Optional fields:

- `animated` (bool): true if the preview is animated (e.g., GIF, APNG)
- `blurhash` (text): BlurHash string for placeholder rendering
- `alt` (text): accessibility description (≤256 bytes)

### 9.2 Wallet behavior

Wallets SHOULD:

- display thumbnails when present
- use `blurhash` for progressive loading if available
- respect aspect ratio from `width`/`height`
- fall back to a generic icon if preview is missing or fails to load

---

### Safety Policy (Normative)

`policy` MUST include:

- `renderable` (bool)
- `executable` (bool)

Wallets MUST NOT execute content without explicit user consent.
Indexers SHOULD surface `executable=true` prominently.

### Mutable Fields (Optional)

If present:

- `mutable.allowed` (bool)
- `mutable.controller` (text): pubkey hex OR script-hash hex
- `mutable.fields` (array of text): JSON-pointer-like paths permitted to change (e.g. `"app.data.state"`)

**Immutable in v2**: `v`, `type`, `creator`, and all `content.*.hash` values.

### Relationships (Non-consensus)

`rels` contains edges: `{ rel: "...", glyph: "glyphid-or-outpoint" }`.
Implementations MAY ignore `rels`.

## Rationale

Glyph v1 remains valid. Glyph v2 is opted in via the version byte (`0x02`) and v2 metadata (`v=2`).

---

### Error Handling (Normative)

### 14.1 Invalid metadata

Indexers MUST reject and not index a Glyph if:

- `v` is missing or not equal to `2`
- `type` is missing
- `name` is missing or exceeds 256 bytes
- `policy` is missing or lacks required fields
- `content` is missing or lacks `primary`
- any `content.*.hash.hex` is malformed (not valid lowercase hex, wrong length)
- total canonical metadata exceeds 256 KB

### 14.2 Malformed but parseable

Indexers SHOULD index but flag as "malformed" if:

- unknown compression or encoding values are used
- `created` timestamp is in the future (>24h)
- `content.*.size` doesn't match actual payload size

### 14.3 Unknown fields

Indexers MUST ignore unknown top-level keys.
Indexers MUST ignore unknown keys within `app.data`.
Indexers SHOULD preserve unknown fields when re-serializing for updates.

---

## Reference Implementation

See REP-3004 for indexer implementation guide and C++ examples.

## Security Considerations

- Wallets MUST NOT execute content without explicit user consent
- Indexers SHOULD surface `executable=true` prominently
- Content hashes are immutable; only whitelisted mutable fields can change
- Controller authorization is required for all updates

## Glossary

| Term                | Definition                                                    |
| ------------------- | ------------------------------------------------------------- |
| **Canonical bytes** | Deterministically serialized metadata (CBOR canonical or JCS) |
| **Commit hash**     | SHA256 of canonical bytes                                     |
| **CEK**             | Content Encryption Key (see REP-3006)                         |
| **Controller**      | Entity authorized to produce updates                          |
| **GlyphID**         | Unique identifier, typically reveal outpoint                  |
| **Outpoint**        | Transaction output reference: `txid:vout`                     |

## Copyright

This document is licensed under the MIT License.
